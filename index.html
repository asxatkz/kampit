<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет продаж и расходов</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .section-title {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #666;
            padding-bottom: 5px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        label {
            display: inline-block;
            width: 200px;
            margin-bottom: 5px;
        }

        input[type="number"] {
            width: 150px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        input[type="date"] {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        .total-section {
            background-color: #e8f5e9;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .message {
            margin-top: 10px;
            padding: 10px;
            display: none;
            border-radius: 4px;
        }

        .success {
            color: green;
            background-color: #e8f5e9;
            border: 1px solid #81c784;
        }

        .error {
            color: red;
            background-color: #ffebee;
            border: 1px solid #e57373;
        }

        .expenses-list {
            margin-top: 10px;
        }

        .expense-item {
            margin-bottom: 5px;
        }

        .add-expense {
            background-color: #2196F3;
            padding: 5px 10px;
            font-size: 12px;
        }

        .remove-expense {
            background-color: #f44336;
            padding: 5px 10px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="section">
        <h2 class="section-title">Дата и остаток</h2>
        <div class="input-group">
            <label>Дата:</label>
            <input type="date" id="datePicker" readonly>
        </div>
        <div class="input-group">
            <label>Остаток наличных:</label>
            <span id="cashBalance">—</span>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Продажа</h2>
        <div class="input-group">
            <label>Терминал:</label>
            <input type="number" id="terminal" value="0">
        </div>
        <div class="input-group">
            <label>Наличные:</label>
            <input type="number" id="cash" value="0">
        </div>
        <div class="input-group">
            <label>Перевод:</label>
            <input type="number" id="transfer" value="0">
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Закуп</h2>
        <div class="input-group">
            <label>Контрагент:</label>
            <input type="text" id="contractor">
        </div>
        <div class="input-group">
            <label>Закуп за нал:</label>
            <input type="number" id="cashPurchase" value="0">
        </div>
        <div class="input-group">
            <label>Закуп за безнал:</label>
            <input type="number" id="cardPurchase" value="0">
        </div>
        <div class="input-group">
            <label>Розничная цена:</label>
            <input type="number" id="retailPrice" value="0">
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Расходы</h2>
        <div class="input-group">
            <label>Зарплата Алтынай:</label>
            <input type="number" id="salaryAltynai" value="0">
        </div>
        <div class="input-group">
            <label>Зарплата Самал:</label>
            <input type="number" id="salarySamal" value="0">
        </div>
        <div id="additionalExpenses" class="expenses-list">
            <!-- Дополнительные расходы будут добавляться сюда -->
        </div>
        <button class="add-expense" onclick="addExpenseField()">+ Добавить расход</button>
    </div>

    <div class="total-section">
        <div class="input-group">
            <label>Выручка:</label>
            <span id="revenue">0</span>
        </div>
        <div class="input-group">
            <label>Остаток на следующий день:</label>
            <span id="nextDayBalance">0</span>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button onclick="calculateTotal()">Рассчитать итог</button>
        <button onclick="saveToSheet()">Сохранить в таблицу</button>
    </div>

    <div id="statusMessage" class="message"></div>

    <script>
        const API_KEY = "AIzaSyCjpZxD7Q7M8NuF5_4M22sCCACGMlGJi_s";
        const SHEET_ID = "1QZcNpX9d8NCqViHPAI9FK8uGNuMRBb7bWt5r4shu9qk";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyFQdMdUSFFHri6NFvBJ8_71YnfWAW1b70NI_iOoAGH6J5dI_yndwoiOO_k_x6o0Q4bGQ/exec";
        let selectedRow = 0;
        let selectedDate = null;
        let expenseCounter = 0;

        function getLocalDate(date = new Date()) {
            const localDate = new Date(date.getTime() + (5 * 60 * 60 * 1000));
            if (localDate.getHours() >= 0 && localDate.getHours() < 5) {
                localDate.setDate(localDate.getDate() - 1);
            }
            localDate.setHours(0, 0, 0, 0);
            return localDate;
        }

        function addExpenseField() {
            expenseCounter++;
            const expenseDiv = document.createElement('div');
            expenseDiv.className = 'expense-item';
            expenseDiv.innerHTML = `
                <div class="input-group">
                    <label>Описание:</label>
                    <input type="text" id="expenseDesc${expenseCounter}">
                    <label style="width: 100px;">Сумма:</label>
                    <input type="number" id="expenseAmount${expenseCounter}" value="0">
                    <button class="remove-expense" onclick="removeExpense(this)">Удалить</button>
                </div>
            `;
            document.getElementById('additionalExpenses').appendChild(expenseDiv);
        }

        function removeExpense(button) {
            button.parentElement.parentElement.remove();
            calculateTotal();
        }

        window.onload = function() {
            try {
                const today = getLocalDate();
                console.log('Local date:', today);
                document.getElementById("datePicker").valueAsDate = today;
                handleDateSelection(today);
            } catch (error) {
                showMessage('Ошибка при загрузке: ' + error.message, true);
            }
        };

        // ... (оставляем существующие функции fetchData, getSheetNameForMonth, loadPreviousDayData, handleDateSelection без изменений)

        function calculateTotal() {
            try {
                const cashBalance = parseFloat(document.getElementById("cashBalance").innerText) || 0;
                const terminal = parseFloat(document.getElementById("terminal").value) || 0;
                const cash = parseFloat(document.getElementById("cash").value) || 0;
                const transfer = parseFloat(document.getElementById("transfer").value) || 0;
                const cashPurchase = parseFloat(document.getElementById("cashPurchase").value) || 0;

                // Рассчитываем дополнительные расходы
                let additionalExpensesTotal = 0;
                document.querySelectorAll('[id^="expenseAmount"]').forEach(input => {
                    additionalExpensesTotal += parseFloat(input.value) || 0;
                });

                // Зарплаты
                const salaryAltynai = parseFloat(document.getElementById("salaryAltynai").value) || 0;
                const salarySamal = parseFloat(document.getElementById("salarySamal").value) || 0;
                
                // Закупы
                const cardPurchase = parseFloat(document.getElementById("cardPurchase").value) || 0;
                
                // Расчет выручки
                const revenue = terminal + cash + transfer + cashPurchase - cashBalance;
                document.getElementById("revenue").innerText = revenue;

                // Расчет остатка на следующий день
                const totalExpenses = salaryAltynai + salarySamal + additionalExpensesTotal;
                const nextDayBalance = revenue - totalExpenses;
                document.getElementById("nextDayBalance").innerText = nextDayBalance;
                document.getElementById("totalBalance").innerText = nextDayBalance;
            } catch (error) {
                showMessage('Ошибка расчета: ' + error.message, true);
            }
        }

        // ... (оставляем существующие функции showMessage и saveToSheet без изменений)

    </script>
</body>
</html>
