<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£—á–µ—Ç –º–∞–≥–∞–∑–∏–Ω–∞</title>
</head>
<body>
    <h1>üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –º–∞–≥–∞–∑–∏–Ω–∞</h1>

    <div class="section">
        <div class="header-row">
            <label>üìÖ –î–∞—Ç–∞: <input type="date" id="date" required></label>
            <label>üí∞ –û—Å—Ç–∞—Ç–æ–∫: <input type="number" id="balance" readonly></label>
        </div>
    </div>

    <div class="section">
        <h2>üíµ –ü—Ä–æ–¥–∞–∂–∏</h2>
        <label>üí≥ –¢–µ—Ä–º–∏–Ω–∞–ª: <input type="number" id="terminal" required></label>
        <label>üíµ –ù–∞–ª–∏—á–Ω—ã–µ: <input type="number" id="cash" required></label>
        <label>üì≤ –ü–µ—Ä–µ–≤–æ–¥—ã: <input type="number" id="transfers" required></label>
        <label>‚úÖ –ò—Ç–æ–≥–æ: <input type="number" id="total" readonly></label>
    </div>

    <div class="section">
        <h2>üì¶ –ó–∞–∫—É–ø–∫–∏ 
            <button type="button" onclick="addSupply()" style="background: #27ae60">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</button>
        </h2>
        <div id="supplies">
            <div class="supply-section">
                <div class="dynamic-row">
                    <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞" class="supplier">
                    <input type="number" placeholder="–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∞" class="price">
                    <input type="number" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏" class="sale">
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üë• –ó–∞—Ä–ø–ª–∞—Ç—ã</h2>
        <label>–ê–ª—Ç—ã–Ω–∞–π: <input type="number" id="altynai" required></label>
        <label>–°–∞–º–∞–ª: <input type="number" id="samal" required></label>
    </div>

    <div class="error-message" id="errorMessage"></div>
    
    <button onclick="sendData()" style="background: #e67e22">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç</button>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyiBzbaoGem_qJIbU6Czl42itWVGRKxqDrmVyej_wUL10TzIZPZESjv2p469ehaVllE/exec";
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Å—Ç–∞—Ç–æ–∫ —Å Google –¢–∞–±–ª–∏—Ü—ã
        async function getLastBalance() {
            const response = await fetch(SCRIPT_URL + '?action=getBalance');
            const data = await response.json();
            return data.balance || 0;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            const lastBalance = await getLastBalance();
            document.getElementById('balance').value = lastBalance;
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç
        const calculateTotal = () => {
            const terminal = parseFloat(document.getElementById('terminal').value) || 0;
            const cash = parseFloat(document.getElementById('cash').value) || 0;
            const transfers = parseFloat(document.getElementById('transfers').value) || 0;
            document.getElementById('total').value = terminal + cash + transfers;
        };

        ['terminal', 'cash', 'transfers'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateTotal);
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
        function addSupply() {
            const div = document.createElement('div');
            div.className = 'supply-section';
            div.innerHTML = `
                <div class="dynamic-row">
                    <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞" class="supplier">
                    <input type="number" placeholder="–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∞" class="price">
                    <input type="number" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏" class="sale">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #e74c3c; padding: 8px 12px">√ó</button>
                </div>
            `;
            document.getElementById('supplies').appendChild(div);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function sendData() {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.style.display = 'none';

            try {
                const data = {
                    date: document.getElementById('date').value,
                    terminal: document.getElementById('terminal').value,
                    cash: document.getElementById('cash').value,
                    transfers: document.getElementById('transfers').value,
                    total: document.getElementById('total').value,
                    altynai: document.getElementById('altynai').value,
                    samal: document.getElementById('samal').value,
                    balance: document.getElementById('balance').value || "0",
                    supplies: Array.from(document.querySelectorAll('.supply-section')).map(section => ({
                        supplier: section.querySelector('.supplier').value,
                        price: section.querySelector('.price').value,
                        sale: section.querySelector('.sale').value
                    }))
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                alert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Google –¢–∞–±–ª–∏—Ü—É!');
                localStorage.setItem('lastBalance', result.newBalance); // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫
                location.reload();
            } catch (error) {
                errorMessage.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                errorMessage.style.display = 'block';
                window.scrollTo(0, 0);
            }
        }
    </script>
</body>
</html>
