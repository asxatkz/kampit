<!DOCTYPE html>
<html lang="ru">
<!-- ... (head остается без изменений) ... -->
<body>
    <!-- ... (body HTML остается без изменений) ... -->
    <script>
        // ... (начало скрипта остается без изменений) ...

        // Обновленная функция получения локальной даты
        function getLocalDate(date = new Date()) {
            // Создаем новую дату, добавляя 5 часов к UTC
            const localDate = new Date(date.getTime() + (5 * 60 * 60 * 1000));
            
            // Проверяем, если после добавления 5 часов мы перешли на следующий день
            if (localDate.getHours() >= 0 && localDate.getHours() < 5) {
                localDate.setDate(localDate.getDate() - 1);
            }
            
            // Устанавливаем время на начало дня
            localDate.setHours(0, 0, 0, 0);
            return localDate;
        }

        window.onload = function() {
            try {
                const today = getLocalDate();
                console.log('Local date:', today); // Для отладки
                document.getElementById("datePicker").valueAsDate = today;
                handleDateSelection(today);
            } catch (error) {
                showMessage('Ошибка при загрузке: ' + error.message, true);
            }
        };

        // Обновленный обработчик выбора даты
        document.getElementById("datePicker").addEventListener("change", function() {
            const selectedDate = new Date(this.value);
            const localDate = getLocalDate(selectedDate);
            handleDateSelection(localDate);
        });

        function handleDateSelection(date) {
            selectedRow = date.getDate();
            selectedDate = date;
            console.log('Selected date:', date); // Для отладки
            loadPreviousDayData(date);
        }

        // ... (остальной код остается без изменений) ...

        function saveToSheet() {
            try {
                // ... (начало функции остается без изменений) ...

                addField('row', selectedRow);
                addField('value', totalBalance);
                addField('sales', document.getElementById("sales").value);
                addField('expenses', document.getElementById("expenses").value);
                addField('month', currentMonth);
                addField('date', selectedDate.toISOString());
                addField('timezone', 'UTC+5'); // Добавляем информацию о часовом поясе

                // ... (остальная часть функции остается без изменений) ...
            } catch (error) {
                showMessage('Ошибка сохранения: ' + error.message, true);
            }
        }
    </script>
</body>
</html>
