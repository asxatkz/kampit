<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Остаток наличных</title>
</head>
<body>
    <h2>Выберите дату:</h2>
    <input type="date" id="datePicker">
    
    <div id="initialBalanceBlock" style="display: none;">
        <h3>Введите начальный остаток:</h3>
        <input type="number" id="initialBalance" value="0">
        <button onclick="saveInitialBalance()">Установить начальный остаток</button>
    </div>

    <h3>Остаток наличных за предыдущий день: <span id="cashBalance">—</span></h3>
    
    <label>Продажи: <input type="number" id="sales" value="0"></label><br>
    <label>Расходы: <input type="number" id="expenses" value="0"></label><br>
    
    <button onclick="calculateTotal()">Рассчитать итог</button>
    
    <h3>Итоговая сумма: <span id="totalBalance">—</span></h3>
    
    <button onclick="saveToSheet()">Сохранить в таблицу</button>

    <script>
        const API_KEY = "AIzaSyCjpZxD7Q7M8NuF5_4M22sCCACGMlGJi_s";
        const SHEET_ID = "1QZcNpX9d8NCqViHPAI9FK8uGNuMRBb7bWt5r4shu9qk";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyFQdMdUSFFHri6NFvBJ8_71YnfWAW1b70NI_iOoAGH6J5dI_yndwoiOO_k_x6o0Q4bGQ/exec";
        let selectedRow = 0;

        async function getPreviousDayBalance() {
            const today = new Date();
            const previousDay = new Date(today);
            previousDay.setDate(today.getDate() - 1);
            
            const previousDayRow = previousDay.getDate();
            
            const RANGE = "G2:G100";
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                const values = data.values || [];
                
                if (values[previousDayRow - 2] && values[previousDayRow - 2][0]) {
                    document.getElementById("cashBalance").innerText = values[previousDayRow - 2][0];
                    document.getElementById("initialBalanceBlock").style.display = "none";
                } else {
                    document.getElementById("cashBalance").innerText = "Нет данных за предыдущий день";
                    document.getElementById("initialBalanceBlock").style.display = "block";
                }
            } catch (error) {
                console.error("Ошибка получения данных:", error);
                document.getElementById("cashBalance").innerText = "Ошибка получения данных";
                document.getElementById("initialBalanceBlock").style.display = "block";
            }
        }

        function saveInitialBalance() {
            const initialBalance = document.getElementById("initialBalance").value;
            if (!initialBalance) {
                alert("Введите начальный остаток!");
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GAS_URL;
            form.target = '_blank';

            const addField = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };

            // Сохраняем начальный остаток в первый день месяца
            addField('row', '2');  // Строка 2 для первого дня
            addField('value', initialBalance);
            addField('isInitial', 'true');

            document.body.appendChild(form);
            form.submit();

            setTimeout(() => {
                document.body.removeChild(form);
                setTimeout(getPreviousDayBalance, 2000);
                setTimeout(() => {
                    alert("Начальный остаток установлен!");
                }, 2100);
            }, 100);
        }

        // Остальной код остается без изменений...
        // (оставьте весь существующий код fetchData, calculateTotal, saveToSheet и т.д.)

    </script>
</body>
</html>
