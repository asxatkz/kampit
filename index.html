<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Остаток наличных</title>
</head>
<body>
    <h2>Выберите дату:</h2>
    <input type="date" id="datePicker">
    
    <h3>Остаток наличных: <span id="cashBalance">—</span></h3>
    
    <label>Продажи: <input type="number" id="sales" value="0"></label><br>
    <label>Расходы: <input type="number" id="expenses" value="0"></label><br>
    
    <button onclick="calculateTotal()">Рассчитать итог</button>
    
    <h3>Итоговая сумма: <span id="totalBalance">—</span></h3>
    
    <button onclick="saveToSheet()">Сохранить в таблицу</button>

    <script>
        const API_KEY = "AIzaSyCjpZxD7Q7M8NuF5_4M22sCCACGMlGJi_s";
        const SHEET_ID = "1QZcNpX9d8NCqViHPAI9FK8uGNuMRBb7bWt5r4shu9qk";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyFQdMdUSFFHri6NFvBJ8_71YnfWAW1b70NI_iOoAGH6J5dI_yndwoiOO_k_x6o0Q4bGQ/exec";
        let selectedRow = 0;

        // Функция для получения данных через Google Sheets API
        async function fetchData() {
            const RANGE = "H2:H100";
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.values || [];
        }

        // Выбор даты и загрузка остатка наличных
        document.getElementById("datePicker").addEventListener("change", async function() {
            const selectedDate = new Date(this.value);
            const day = selectedDate.getDate();
            selectedRow = day;
            
            const cashData = await fetchData();
            if (cashData[day - 2]) {
                document.getElementById("cashBalance").innerText = cashData[day - 2][0];
            } else {
                document.getElementById("cashBalance").innerText = "Нет данных";
            }
        });

        // Расчет итоговой суммы
        function calculateTotal() {
            const cashBalance = parseFloat(document.getElementById("cashBalance").innerText) || 0;
            const sales = parseFloat(document.getElementById("sales").value) || 0;
            const expenses = parseFloat(document.getElementById("expenses").value) || 0;
            const total = cashBalance + sales - expenses;
            document.getElementById("totalBalance").innerText = total;
        }

        // Запись итоговой суммы в таблицу через Google Apps Script
        async function saveToSheet() {
            const totalBalance = document.getElementById("totalBalance").innerText;
            if (selectedRow === 0 || totalBalance === "—") {
                alert("Выберите дату и рассчитайте итог!");
                return;
            }

            const formData = new FormData();
            formData.append('row', selectedRow + 1);
            formData.append('value', totalBalance);

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Добавляем этот параметр
                    body: formData
                });

                // Так как мы используем no-cors, мы не можем прочитать ответ
                // Просто показываем сообщение об успехе
                alert("Данные отправлены!");
            } catch (error) {
                console.error("Ошибка сохранения:", error);
                alert("Ошибка записи в таблицу!");
            }
        }
    </script>
</body>
</html>
