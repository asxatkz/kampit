<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Остаток наличных</title>
</head>
<body>
    <h2>Выберите дату:</h2>
    <input type="date" id="datePicker">
    
    <h3>Остаток наличных: <span id="cashBalance">—</span></h3>
    
    <label>Продажи: <input type="number" id="sales" value="0"></label><br>
    <label>Расходы: <input type="number" id="expenses" value="0"></label><br>
    
    <button onclick="calculateTotal()">Рассчитать итог</button>
    
    <h3>Итоговая сумма: <span id="totalBalance">—</span></h3>
    
    <button onclick="saveToSheet()">Сохранить в таблицу</button>

    <script>
        const API_KEY = "AIzaSyCjpZxD7Q7M8NuF5_4M22sCCACGMlGJi_s";
        const SHEET_ID = "1QZcNpX9d8NCqViHPAI9FK8uGNuMRBb7bWt5r4shu9qk";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyFQdMdUSFFHri6NFvBJ8_71YnfWAW1b70NI_iOoAGH6J5dI_yndwoiOO_k_x6o0Q4bGQ/exec";
        let selectedRow = 0;

        // Устанавливаем сегодняшнюю дату при загрузке страницы
        window.onload = function() {
            const today = new Date();
            document.getElementById("datePicker").valueAsDate = today;
            handleDateSelection(today);
        };

        async function fetchData(month) {
            const sheetName = getSheetNameForMonth(month);
            const RANGE = `${sheetName}!G1:G100`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.values || [];
        }

        function getSheetNameForMonth(date) {
            const months = [
                'Январь', 'Февраль', 'Март', 'Апрель', 
                'Май', 'Июнь', 'Июль', 'Август',
                'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            return months[date.getMonth()];
        }

        // Функция загрузки данных за предыдущий день
        async function loadPreviousDayData(currentDate) {
            const previousDay = new Date(currentDate);
            previousDay.setDate(currentDate.getDate() - 1);
            
            // Получаем данные из нужного листа
            const cashData = await fetchData(previousDay);
            const prevDayRow = previousDay.getDate();
            
            if (cashData[prevDayRow - 1]) {
                document.getElementById("cashBalance").innerText = cashData[prevDayRow - 1][0];
            } else {
                // Если это первое число месяца, пытаемся получить данные за последний день предыдущего месяца
                if (currentDate.getDate() === 1) {
                    const lastMonthDate = new Date(currentDate);
                    lastMonthDate.setDate(0); // Переходим к последнему дню предыдущего месяца
                    const lastMonthData = await fetchData(lastMonthDate);
                    const lastDayOfMonth = lastMonthDate.getDate();
                    
                    if (lastMonthData[lastDayOfMonth - 1]) {
                        document.getElementById("cashBalance").innerText = lastMonthData[lastDayOfMonth - 1][0];
                    } else {
                        document.getElementById("cashBalance").innerText = "0";
                    }
                } else {
                    document.getElementById("cashBalance").innerText = "0";
                }
            }
        }

        function handleDateSelection(date) {
            selectedRow = date.getDate();
            loadPreviousDayData(date);
        }

        // Обработчик выбора даты
        document.getElementById("datePicker").addEventListener("change", function() {
            const selectedDate = new Date(this.value);
            handleDateSelection(selectedDate);
        });

        function calculateTotal() {
            const cashBalance = parseFloat(document.getElementById("cashBalance").innerText) || 0;
            const sales = parseFloat(document.getElementById("sales").value) || 0;
            const expenses = parseFloat(document.getElementById("expenses").value) || 0;
            const total = cashBalance + sales - expenses;
            document.getElementById("totalBalance").innerText = total;
        }

        function saveToSheet() {
            const totalBalance = document.getElementById("totalBalance").innerText;
            if (selectedRow === 0 || totalBalance === "—") {
                alert("Выберите дату и рассчитайте итог!");
                return;
            }

            const selectedDate = new Date(document.getElementById("datePicker").value);
            const currentMonth = getSheetNameForMonth(selectedDate);

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GAS_URL;
            form.target = 'hidden_iframe';

            let iframe = document.getElementById('hidden_iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe';
                iframe.id = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }

            const addField = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };

            addField('row', selectedRow);
            addField('value', totalBalance);
            addField('sales', document.getElementById("sales").value);
            addField('expenses', document.getElementById("expenses").value);
            addField('month', currentMonth);

            document.body.appendChild(form);
            form.submit();

            setTimeout(() => {
                document.body.removeChild(form);
                setTimeout(async () => {
                    await loadPreviousDayData(selectedDate);
                    alert("Данные успешно сохранены!");
                }, 2000);
            }, 100);
        }
    </script>
</body>
</html>
